---
title: "Estimating parameters using the combined approach"
author: Saskia Schirmer
output:
  rmarkdown::html_vignette:
    fig_width: 5
    fig_height: 4.5
    toc: true
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{EstimatingParameterUsingTheCombinedApproach}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(CONSURE)
```

The combined approach should be used if spatial continuous values are wanted for survival and migratory connectivity and if the recovery probability cannot be assumed to be constant over space. Be aware that the combined approach needs considerable more computational time. It combines estimates in discrete non-breeding space and estimates from the continuous approach by optimizing a function to fit both estimates as good as possible.

## One-dimensional space

### Simulated data

The example datasets for the continuous approach are simulated with a linearly increasing recovery probability over space. The data is simulated as described in the vignette on simulating data. The constructor in one-dimensional space looks like the following:

```{r warning=FALSE}
mro <- markRecaptureObject(xrange = c(0,1),
                           survival = function(w){0.5*w+.4},
                           recovery = function(w){
                             0.2*w+0.01
                           },
                           markedInds = c(100000,110000,90000,80000) ,
                          migratoryConnectivity = function(b,w,B=4){
                             truncnorm::dtruncnorm(w,0,1, mean = seq(0.1,0.9,length.out = B)[b], sd = 0.3)},
                          observationTime = 10)

mro <- simContin(mro)
mro <- estKDE(mro, all = TRUE)
mro <- estKDE(mro)
mro <- estS(markRecaptureObject = mro)
mro <- estM(mro, all  = TRUE)
mro <- estM(mro)
mro <- estR(mro)
```

Additionally, a split-vector specifies which point belongs to which discrete non-breeding area. Therefore, the length of the split-vector must equal the spatial resolution of the data.

```{r}
split <- rep(1:4, each = 25)
```


The true values of the parameters can be visualized with the function plotMsr:

```{r fig.fullwidth=TRUE, fig.width=7, fig.height=5}
plotMsr(mro, ylim = c(0,2.5))
```

The raw data looks like the following

```{r fig.fullwidth=TRUE, fig.width=7}
plotRawRecoveries(mro, facetByAge = TRUE)
```

### Estimating the parameters

Firstly, the continuous parameters must be estimated as described in the vignette on estimating continuous parameters.

If we have simulated data and know the true migratory connectivity function, we can calculate the proportion in every non-breeding area. Therefore, we must define the edges of the discrete non-breeding areas. In the moment, this is only possible, when the non-breeding areas are of rectangular shape. Otherwise, the proportion can be given directly in a later step. The vector knots_prop contains in one-dimensional space the knots separating the discrete non-breeding areas.

```{r}
knots_prop <-list(latitude = c(0,0.25, 0.5, 0.75,1),
                  longitude = NULL)
```

Now, the integral under the true migratory connectivity for every non-breeding area is calculated and stored in the breedingArea-object of the markRecaptureObject.

```{r}
mro <- calcDiscreteM(mro,knots_prop = knots_prop)
mro$breedingAreas$all$mDiscrete
```

Now, we need to initialize an ptimizationObject for the optimization. We forward the markRecaptureObject, the name of the breeding area to be optimized, the split-vector and a vector for lambda. The first entry in this vector is the weight for the smoothing penalty. The second entry is the weight for the penalty of the discrete value. The values are chosen arbitrarily. Which values to choose is not straightforward. Too high values for $\lambda_1$ will lead to a linear combined migratory connectivity estimate. Too low values will lead to a highly variable estimate. How $\lambda_1$ affects the estimate also depends on the value of $\lambda_2$. If $\lambda_2$ is set too low, but $\lambda_1$ enables a good fit (not too smooth but not too wiggly), then the estimate will be close to the continuous estimate of migratory connectivity and not fit the discrete area under the curve. If $\lambda_2$ is set too high, it will only reflect the smoothing of the histogram given by the discrete values. Nevertheless, the true underlying curve may be just the smoothing of the histogram, e.g., in the case of a normal distribution shown in the example.
```{r}
oO <- optimizationObject(markRecaptureObject = mro,
                         b = "all",
                         split = split,
                         lambda  = c(.05,300))
```

Now, we start the optimization. The changeR-argument should be set to TRUE, when the optimization is for the aggregated dataset (breeding area "all"). Then, the combined estimate for the recovery probability will be estimated additionally to the migratory connectivity and the continuous migratory connectivity estimators will be corrected for the overall combined migratory connectivity and stored under markRecaptureObject$estimates$mCorrected. The arguments startTimes, maxit and reltol belong to the optim-function. For additional information see ?optim. The optimization algorithm should be started several times to prevent the process from getting stuck in local minima. If running combEstimate again reveals a different result, the number of startTimes should be set higher. Depending on your problem the optimization algorithm will not converge in the maximum iterations. Then you can simply increase the number of maxit. The reltol argument should be neither too high nor too low. The default value should be ok in most cases. 
```{r}
tmp <- combEstimate(oO,startTimes = 10, maxit = 100000, reltol = 1e-8,changeR = TRUE)
```

The output of combEstimate contains additionally to the markRecaptureObject with the combined estimates a data.frame with the results from every repetition of the optim-function. The vector val contains the values of the repetitions.
```{r}
str(tmp, max.level = 1)
```

Therefore, the markRecaptureObject from the output must be saved in the initial markRecaptureObject.
```{r}
mro <- tmp$markRecaptureObject
```

The combined estimator of the migratory connectivity can be visualized using the plotCombM-function. The breeding area to be plotted is hidden in the optimizationObject. So, check the value of optimizationObject$b if another breeding area seems to be plotted than you expect.
```{r}
mPlotAll <- plotCombM(mro,oO, zlim = c(0,2.6))
```

The combined estimator of the recovery probability can be visualized using the plotCombM-function.

```{r}
rPlotAll <- plotCombR(mro,oO)
```
## Two-dimensional space

```{r eval=FALSE}
mro2 <- markRecaptureObject(xrange = c(0,1),
                            yrange = c(0,1),
                            survival = function(w){-sum(0.25*w)+0.9},
                            recovery = function(w){ sum(0.2*w[1])+0.01},
                            markedInds = rep(100000,4) ,
                            migratoryConnectivity = function(b,w,lb=0,ub=1,B=4){
                                tmvtnorm::dtmvnorm(w,
                                                   mean = c(c(0.1,0.3,0.6,0.9)[b],c(0.15,0.2,0.5,0.75)[b]),
                                                 sigma = diag(0.05,2), lower = rep(lb,2),
                                                 upper = rep(ub,2))
                            },
                            observationTime = 10)

mro2 <- simContin(mro2)
mro2 <- estKDE(mro2, all = TRUE)
mro2 <- estKDE(mro2)
mro2 <- estS(markRecaptureObject = mro2)
mro2 <- estM(mro2, all  = TRUE)
mro2 <- estM(mro2)
mro2 <- estR(mro2)
```

The split-vector may look like the following:
```{r eval=FALSE}
split <- c(rep(rep(1:2, each = 50),50),rep(rep(3:4, each = 50),50))
```

```{r fig.fullwidth=TRUE, fig.width=7, fig.height=5, eval=FALSE}
plotMsr(mro2)
```

