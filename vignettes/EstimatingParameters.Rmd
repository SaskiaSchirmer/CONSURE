---
title: "Estimating parameters using the continuous approach"
author: Saskia Schirmer
output:
  rmarkdown::html_vignette:
    fig_width: 5
    fig_height: 4.5
    toc: true
    toc_depth: 4
vignette: >
  %\VignetteIndexEntry{EstimatingParametersUsingTheContinuousApproach}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(CONSURE)
```



## Estimating the parameters

CONSURE can estimate the three parameters survival, migratory connectivity and recovery probability. This is possible in one- and two-dimensional space. The code is the same, but the functions need more computational time in two-dimensional space and the plots look different. Therefore, we show both possibilities here. You may choose the option, which looks more like the one you want to solve. 

### One-dimensional space
We load simulated data as shown in the [vignette on simulating data](SimulatingData.html).

```{r}
B <- 5    # number of breeding areas

mro <- markRecaptureObject(xrange = c(0,1),
                    survival = function(w){0.5*w+.4},
                    recovery = function(w){0.01},
                    migratoryConnectivity = function(b,w,B=B){
                      truncnorm::dtruncnorm(w,0,1, 
                                            mean = seq(0.1,0.9,length.out = B)[b], 
                                            sd = 0.3)},
                    markedInds = rep(100000,B),
                    observationTime = 10)

mro <- simContin(mro)
```

The parameters are estimated in every point. Theoretically, it would be possible to estimate a value for every point in space. Practically, we estimate values on a point grid, with a resolution high enough that we can visualize it as a continuous estimate, but small enough that computation time is short and storage small. To obtain a coarse overview we set the reslution to 100:

```{r}
res <- 100
```

#### The data

We use two subsets of the data. The first is the dead recoveries aggregated over all breeding areas. The raw data points facetted by age and area look like the following:
```{r fig.fullwidth=TRUE, fig.width=7}
plotRawRecoveries(mro, facetByAge = TRUE)
```

The second dataset contains the dead recoveries for each separate breeding area:
```{r fig.fullwidth=TRUE, fig.width=7}
 plotRawRecoveries(mro, facetByAge = TRUE, facetByArea = TRUE)
```


#### Estimating the aggregated kernel density


From these data points we estimate the kernel density. We need to do this twice. One time for the aggregated dataset over all breeding areas and one time for each breeding area separately. The result needs can be stored under the same name as the initialized markRecaptureObject:
```{r}
mro <- estKDE(mro, all = TRUE)
```

```{r fig.fullwidth=TRUE}
plotKDE("all", mro,trueValuesAvailable = TRUE)
```

#### Estimating survival

Having a density estimate for the aggregated dataset of breeding areas makes it possible to estimate survival. 
```{r warning=FALSE}
mro <- estS(markRecaptureObject = mro)
```

The robust estimation of the linear model often throws warnings when the algorithm does not converge. You should be careful if the number of warnings is a large amount of the resolution. When it is only a few the effect is neglectable.

The plot shows the estimated survival using a robust linear model. If you also want to visualize the true survival with which the data is simulated, the argument trueValuesAvailable must be set to TRUE:

```{r fig.fullwidth=TRUE}
plotS(mro, trueValuesAvailable = TRUE)
```


#### Estimating kernel density separately for each breeding area

To estimate migratory connectivity and recovery probability, we need a kernel density estimate for each breeding area. We do this by leaving the argument all set to FALSE as it is by default. We do not have to specify every breeding area by name. The function will estimate the kernel density for each breeding area automatically.

```{r}
mro <- estKDE(mro)
```

The plot for each breeding area can be plotted by adding its name to the plotKDE-function:
```{r fig.fullwidth=TRUE}
plotKDE("b1", mro,trueValuesAvailable = TRUE)
```

#### Estimating the migratory connectivity

Now, we can estimate the migratory connectivity for the aggregated dataset of all breeding areas:

```{r warning=FALSE}
mro <- estM(mro, all  = TRUE)
```

and plot its shape:

```{r fig.fullwidth=TRUE}
plotM(mro,"all", trueValuesAvailable = TRUE)
```

We can also estimate the migratory connectivity for each breeding area. It is estimated for all breeding areas simultaneously, so no breeding area name has to be specified.

```{r warning=FALSE}
mro <- estM(mro)
```

The plot looks like the following:

```{r fig.fullwidth=TRUE}
plotM(mro,"b1", trueValuesAvailable = TRUE)
```

#### Estimating the constant recovery probability

Finally, we can estimate the recovery probability. It is a constant over the whole non-breeding area and does not depend on the breeding origin.
```{r}
mro <- estR(mro)

mro$estimates$r
mro$winteringArea$recovery(0.5)
```
### Two-dimensional space
We load simulated data as shown in the [vignette on simulating data](SimulatingData.html).

```{r}
mro2 <- markRecaptureObject(xrange = c(0,1),
                            yrange = c(0,1),
                            survival = function(w){-sum(0.2*w)+0.9},
                            recovery = function(w){0.01},
                            markedInds = rep(100000,5) ,
                            migratoryConnectivity = function(b,w,lb=0,ub=1,B=5){
                              tmvtnorm::dtmvnorm(w, mean = rep(seq(0.1,0.9,length.out = B)[b],2),
                                                 sigma = diag(0.3,2), lower = rep(lb,2),
                                                 upper = rep(ub,2))
                            },
                            observationTime = 10)

mro2 <- simContin(mro2)
```

The parameters are estimated in every point. Theoretically, it would be possible to estimate a value for every point in space. Practically, we estimate values on a point grid, with a resolution high enough that we can visualize it as a continuous estimate, but small enough that computation time is short and storage small. To obtain a coarse overview we set the reslution to 100:

```{r}
res <- 100
```

This results into a grid of 100x100 points.


#### The data

We use two subsets of the data. The first is the dead recoveries aggregated over all breeding areas. There are many datapoints in this dataset. We only plot the age classes 7 to 10. This can be specified by ageMin and ageMax. The raw data points facetted by age and area look like the following:

```{r fig.fullwidth=TRUE, fig.width=7}
plotRawRecoveries(mro2, facetByAge = TRUE, ageMin = 7, ageMax = 10)
```

The second dataset contains the dead recoveries for each separate breeding area:
```{r fig.fullwidth=TRUE, fig.width=7}
 plotRawRecoveries(mro2, facetByAge = TRUE, facetByArea = TRUE, ageMin = 7, ageMax = 10)
```

#### Estimating the aggregated kernel density


From these data points we estimate the kernel density. We need to do this twice. One time for the aggregated dataset over all breeding areas and one time for each breeding area separately. The result needs can be stored under the same name as the initialized markRecaptureObject:
```{r}
mro2 <- estKDE(mro2, all = TRUE)
```

```{r fig.fullwidth=TRUE, fig.width=7}
plotKDE("all", mro2,trueValuesAvailable = TRUE)
```

#### Estimating survival

Having a density estimate for the aggregated dataset of breeding areas makes it possible to estimate survival. 
```{r warning=FALSE}
mro2 <- estS(markRecaptureObject = mro2)
```

The robust estimation of the linear model often throws warnings when the algorithm does not converge. You should be careful if the number of warnings is a large amount of the resolution. When it is only a few the effect is neglectable.

```{r fig.fullwidth=TRUE, fig.width=7}
plotS(mro2, trueValuesAvailable = TRUE)
```

#### Estimating the kernel density separately for each breeding area
To estimate migratory connectivity and recovery probability, we need a kernel density estimate for each breeding area:

```{r}
mro2 <- estKDE(mro2)
```

The plot for each breeding area can be plotted by adding its name to the plotKDE-function:
```{r fig.fullwidth=TRUE, fig.width=6}
plotKDE("b1", mro2,trueValuesAvailable = TRUE)
```

#### Estimating migratory connectivity

Now, we can estimate the migratory connectivity for the aggregated dataset of all breeding areas:

```{r warning=FALSE}
mro2 <- estM(mro2, all  = TRUE)
```

and plot its shape. Note, that the plot function is not capable of plotting the true migratory connectivity for the aggregated dataset in the moment.

```{r fig.fullwidth=TRUE}
plotM(mro2,"all", trueValuesAvailable = TRUE)
```

We can also estimate the migratory connectivity for each breeding area. It is estimated for all breeding areas simultaneously, so no breeding area name has to be specified.

```{r warning=FALSE}
mro2 <- estM(mro2)
```

The plot looks like the following:

```{r fig.fullwidth=TRUE, fig.width=7, fig.height=6}
plotM(mro2,"b2", trueValuesAvailable = TRUE)
```

#### Estimating the recovery probability

Finally, we can estimate the recovery probability. It is a constant over the whole non-breeding area and does not depend on the breeding origin. The estimated value is stored in estimates\$r. The true recovery probability function ist stored under winteringArea\$recovery. For the latter we can choose an arbitrary value inside the non-breeding area to obtain the recovery probability as it is constant in every point.
```{r}
mro2 <- estR(mro2)

mro2$estimates$r
mro2$winteringArea$recovery(c(0.5,0.5))
```
